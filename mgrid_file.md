# `mgrid` file

The `mgrid` file (as specified via `mgrid_file` in VMEC's `INDATA` namelist) contains the magnetic field
(and the magnetic vector potential in newer versions) generated by external coils.
It is generated from the coils geometry and the currents in the coils using the [`MAKEGRID` code](https://github.com/ORNL-Fusion/MAKEGRID).
The free-boundary iterations of VMEC require the magnetic field on the last closed flux surface (LCFS),
which changes shape as the free-boundary iterations proceed.

Instead of re-evaluating the Biot-Savart integrals over the coil geometry for every free-boundary iteration,
the magnetic field is computed once and stored in the `mgrid` file.
Bilinear interpolation (not divergence-free!) is then used to interpolate the magnetic field
to the positions on the LCFS.

Among the inputs to `MAKEGRID` is the flag `lstell_sym`.
It controls whether to make use of [Stellarator symmetry](https://doi.org/10.1016/S0167-2789(97)00216-9) or not to reduce the required number of toroidal grid points per field period.

The `mgrid` file is stored in the NetCDF format.
The following scalar variables are usually available:
* `ir` number of grid points in `R` direction
* `jz` number of grid points in `Z` direction
* `kp` number of grid points in (toroidal) `phi` direction
* `nfp` number of field periods in the toroidal direction (HSX: 4, W7-X: 5, etc.)
* `nextcur` number of coil groups (i.e. number of unique coil currents)
* `rmin` minimum `R` value of the grid at which the magnetic field is computed in m
* `zmin` minimum `Z` value of the grid at which the magnetic field is computed in m
* `rmax` maximum `R` value of the grid at which the magnetic field is computed in m
* `zmax` maximum `Z` value of the grid at which the magnetic field is computed in m
* `mgrid_mode` is `'R'` (raw; the outputs are normalized to a unit current on 1A)
               or `'S'` (scaled: the outputs are scaled to require the raw coil currents given to `mgrid`)
* `raw_coil_cur` raw coil currents used in computation when `mgrid_mode` was `'S'` in A

The grid spacing in `R` is `delr = (rmax-rmin)/(ir-1)`.
The grid spacing in `Z` is `delz = (zmax-zmin)/(jz-1)`.
The grid spacing in `phi` is `delp = (2 pi)/nfp / kp`.

The grid points in `R` are located at `rad = rmin + (i - 1)*delr` for `i` in {1, ..., `ir`}.
The grid points in `Z` are located at `zee = zmin + (j - 1)*delz` for `j` in {1, ..., `jz`}.
The grid points in `phi` are located at `phi = (k - 1)*delp` for `k` in {1, ..., `kp`} (no stellarator symmetry)
or for `k` in {1, ..., kp/2+kp%2} in case of stellarator symmetry.

The following quantities are arrays of shape `[kp][jz][ir]`.

The cylindrical components of the magnetic field is contained in separate variables per coil group:
* `br_001` contains the cylindrical `R` component of the magnetic field due to the first coil in T
* `bp_001` contains the cylindrical `phi` component of the magnetic field due to the first coil in T
* `bz_001` contains the cylindrical `Z` component of the magnetic field due to the first coil in T
* `br_002` contains the cylindrical `R` component of the magnetic field due to the second coil in T
* etc.

In more modern versions of the `mgrid` file, also the magnetic vector potential is stored in a similar structure:
* `ar_001` contains the cylindrical `R` component of the magnetic vector potential due to the first coil
* `ap_001` contains the cylindrical `phi` component of the magnetic vector potential due to the first coil
* `az_001` contains the cylindrical `Z` component of the magnetic vector potential due to the first coil
* etc.
